# Image securization

## Example 1

- Create `/etc/kubernetes/admission-control/admission-control.conf`

```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: AdmissionConfiguration
plugins:
- name: ImagePolicyWebhook
  path: imagepolicy.conf
```

- Create `/etc/kubernetes/admission-control/imagepolicy.conf` (imagepolicy.json)

```yaml
{
   "imagePolicy": {
      "kubeConfigFile": "/etc/kubernetes/admission-control/imagepolicy_backend.kubeconfig",
      "allowTTL": 50,
      "denyTTL": 50,
      "retryBackoff": 500,
      "defaultAllow": false 
   }
}
```

- Create `/etc/kubernetes/admission-control/imagepolicy_backend.kubeconfig`

```yaml
apiVersion: v1
kind: Config
clusters:
- name: trivy-k8s-webhook
  cluster:
    certificate-authority: /etc/kubernetes/admission-control/imagepolicywebhook-ca.crt
    server: https://acg.trivy.k8s.webhook:8090/scan
contexts:
- name: trivy-k8s-webhook
  context:
    cluster: trivy-k8s-webhook
    user: api-server
current-context: trivy-k8s-webhook
preferences: {}
users:
- name: api-server
  user:
    client-certificate: /etc/kubernetes/admission-control/api-server-client.crt
    client-key: /etc/kubernetes/admission-control/api-server-client.key
```

- Edit `/etc/kubernetes/manifests/kube-apiserver.yaml`

```yaml
--admission-control-config-file=/etc/kubernetes/admission-control/admission-control.conf
--enable-admission-plugins=NodeRestriction,ImagePolicyWebhook
```
